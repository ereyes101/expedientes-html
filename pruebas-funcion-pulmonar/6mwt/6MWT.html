<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>6MWT ‚Ä¢ Completo (Casas/Troosters, DDR/DSP, Curvas, PDF)</title>
<style>
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:#111;font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e5e5;padding:10px 12px;z-index:3}
  h1{margin:0;font:800 20px/1 system-ui}
  main{max-width:1100px;margin:14px auto;padding:0 12px 80px}
  .card{border:1px solid #e5e5e5;border-radius:10px;margin:10px 0}
  .card>h2{margin:0;padding:10px 12px;border-bottom:1px solid #e5e5e5;font:700 16px/1 system-ui}
  .c{padding:10px 12px}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:8px;align-items:end}
  .row>label{display:flex;flex-direction:column;gap:4px}
  input,select,textarea{border:1px solid #bbb;border-radius:8px;padding:7px 9px}
  .s2{grid-column:span 2}.s3{grid-column:span 3}.s4{grid-column:span 4}.s6{grid-column:span 6}.s12{grid-column:span 12}
  .btn{appearance:none;border:1px solid #d0d0d0;border-radius:8px;background:#f6f7f8;padding:8px 12px;cursor:pointer}
  .btn:active{transform:translateY(1px)} .btn-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #d0d0d0;border-radius:999px;background:#f6f7f8;padding:4px 10px}
  .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .box{border:1px solid #d0d0d0;border-radius:10px;padding:8px}
  .ttl{color:#555;font-size:12px;margin-bottom:4px} .val{font:700 20px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .small{color:#666;font-size:12px} .invalid{border-color:#d33;background:#fff5f5}
  #reloj{font:900 18px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .charts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .chart{width:100%;height:220px;border:1px solid #d0d0d0;border-radius:8px;background:#fff}
  table{border-collapse:collapse;width:100%} th,td{border-bottom:1px solid #e5e5e5;padding:6px;text-align:left;font-size:13px}
  .table-wrap{overflow:auto} .row-current td{background:#f9fafb;font-weight:600}
  .accent{color:#007aff} .accent2{color:#ff2d55} .warn{color:#8a6e00} .danger{color:#b00020}
  @media print{header{display:none}}
</style>
</head>
<body>
<header>
  <div class="btn-row">
    <h1>Prueba de Caminata de 6 Minutos ‚Äî 6MWT (Completo)</h1>
    <button class="btn" id="btn_pdf">üñ®Ô∏è PDF</button>
  </div>
</header>

<main>
  <section class="card"><h2>1) Datos del paciente y configuraci√≥n</h2><div class="c" id="sec-datos">
    <div class="row">
      <label class="s4">Cl√≠nica / Sede
        <input id="clinic_name" list="clinic_list" placeholder="Unidad de Neumolog√≠a">
        <datalist id="clinic_list">
          <option value="Unidad de Neumolog√≠a">
          <option value="Consultorio Medical Center">
          <option value="Cl√≠nica Dumian">
          <option value="Cl√≠nica Junical">
        </datalist>
      </label>
      <label class="s4">Direcci√≥n
        <input id="clinic_addr" placeholder="Calle / Carrera, Ciudad">
      </label>
      <label class="s3">Tel√©fono
        <input id="clinic_tel" placeholder="+57 ...">
      </label>
      <label class="s4">Nombre<input id="p_nombre"></label>
      <label class="s4">Identificaci√≥n<input id="p_id"></label>
      <label class="s2">Edad (a√±os)<input id="p_edad" type="number" min="10" max="100"></label>
      <label class="s2">Sexo<select id="p_sexo"><option value="F">Femenino</option><option value="M">Masculino</option></select></label>
      <label class="s3">Talla (cm)<input id="p_talla" type="number" min="120" max="220" step=".1"></label>
      <label class="s3">Peso (kg)<input id="p_peso" type="number" min="20" max="250" step=".1"></label>
      <label class="s3">Longitud entre conos (m)<input id="p_pista" type="number" min="5" max="60" step=".5" value="30"></label>
      <label class="s3">Ecuaci√≥n<select id="p_eq"><option value="casas" selected>Casas (Bogot√°)</option><option value="troosters">Troosters</option></select></label>
      <label class="s3">Voz<select id="p_voz"><option value="es-CO" selected>es-CO</option><option value="es-419">es-419</option><option value="es-ES">es-ES</option></select></label>
      <label class="s3">Membrete/Logo (PNG/JPG)<input id="logo_file" type="file" accept="image/*"></label>
      <label class="s3">Post #1 (s) <input id="post1_s" type="number" min="0" step="5" value="0"></label>
      <label class="s3">Post #2 (s) <input id="post2_s" type="number" min="0" step="5" value="60"><span class="small">sugerido: 60</span></label>
    </div>
  </div></section>

  <section class="card"><h2>2) Cron√≥metro, vueltas, tabla minuto a minuto, pausas y observaciones</h2>
  <div class="c" id="sec-ejec">
    <div class="btn-row">
      <button class="btn" data-cmd="instr">üîä Instrucciones</button>
      <button class="btn" data-cmd="start">‚ñ∂Ô∏è Iniciar prueba (6:00)</button>
      <button class="btn" data-cmd="mark">üîî Marcar minuto</button>
      <button class="btn" data-cmd="end">‚ñ† Finalizar</button>
      <span id="reloj" class="pill">06:00</span>
    </div>
    <div class="btn-row" style="margin-top:8px">
      <button class="btn" data-cmd="lap">‚ûï Vuelta (+1)</button>
      <button class="btn" data-cmd="undo">‚Ü©Ô∏é Deshacer</button>
      <span class="pill">Vueltas: <span id="laps_disp" class="val">0</span></span>
      <label class="s3">Metros adicionales<input id="extra_m" type="number" min="0" step=".5" value="0"></label>
    </div>

    <div class="table-wrap" style="margin-top:10px">
      <table id="tabla_min">
        <thead><tr><th>Tiempo (min)</th><th>Etiqueta</th><th>SpO‚ÇÇ (%)</th><th>FC (lpm)</th><th>Obs</th></tr></thead>
        <tbody id="tb_min"></tbody>
      </table>
    </div>

    <div style="margin-top:10px">
      <b>Pausas</b>
      <div class="btn-row" style="margin-top:6px">
        <label>Causa
          <select id="pause_cause"><option value="disnea">Disnea</option><option value="dolor">Dolor tor√°cico</option><option value="mareo">Mareo</option><option value="calambres">Calambres</option><option value="oxigeno">Ajuste O‚ÇÇ</option><option value="otra">Otra</option></select>
        </label>
        <button class="btn" data-cmd="pstart">‚è∏Ô∏è Iniciar pausa</button>
        <button class="btn" data-cmd="pend" disabled>‚ñ∂Ô∏è Finalizar pausa</button>
      </div>
      <div class="table-wrap" style="margin-top:6px">
        <table><thead><tr><th>#</th><th>Inicio (s)</th><th>Fin (s)</th><th>Dur (s)</th><th>Causa</th></tr></thead><tbody id="tb_pausas"></tbody></table>
      </div>
    </div>

    <div style="margin-top:10px">
      <b>Observaciones</b>
      <textarea id="obs" rows="2" placeholder="Eventos, s√≠ntomas, incidencias del pasillo‚Ä¶"></textarea>
    </div>
  </div></section>

  <section class="card"><h2>3) Resultados y curvas</h2><div class="c" id="sec-res">
    <div id="alertas" class="small"></div>
    <div class="kpi" style="margin-top:6px">
      <div class="box"><div class="ttl">Distancia (m)</div><div id="k_m" class="val">‚Äî</div></div>
      <div class="box"><div class="ttl">% del predicho | Casas et al</div><div id="k_pct" class="val">‚Äî</div></div>
      <div class="box"><div class="ttl">Predicho (m)</div><div id="k_pred" class="val">‚Äî</div></div>
      <div class="box"><div class="ttl">LLN (m)</div><div id="k_lln" class="val">‚Äî</div></div>
    </div>
    <div class="kpi" style="margin-top:8px">
      <div class="box"><div class="ttl">SpO‚ÇÇ nadir (%)</div><div id="k_nadir" class="val">‚Äî</div></div>
      <div class="box"><div class="ttl">ŒîSpO‚ÇÇ (%)</div><div id="k_delta" class="val">‚Äî</div></div>
      <div class="box"><div class="ttl">DDR (%¬∑min/m)</div><div id="k_ddr" class="val">‚Äî</div></div>
      <div class="box"><div class="ttl">DSP (m¬∑%)</div><div id="k_dsp" class="val">‚Äî</div></div>
    </div>
    <div class="charts" style="margin-top:10px">
      <div><div class="small">Curva <span class="accent">SpO‚ÇÇ</span> vs tiempo</div><canvas id="cv_spo2" class="chart"></canvas></div>
      <div><div class="small">Curva <span class="accent2">FC</span> vs tiempo</div><canvas id="cv_fc" class="chart"></canvas></div>
    </div>
    <div style="margin-top:10px">
      <b>Serie por minuto</b>
      <div class="table-wrap"><table><thead><tr><th>Min</th><th>SpO‚ÇÇ (%)</th><th>FC (lpm)</th><th>Obs</th></tr></thead><tbody id="tb_min_recap"></tbody></table></div>
    </div>
    <div style="margin-top:10px"><b>An√°lisis e interpretaci√≥n</b><div id="interpretacion" class="small" style="margin-top:4px"></div></div>
  </div></section>
</main>

<audio id="beep" preload="auto"><source type="audio/wav" src="data:audio/wav;base64,UklGRoYAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAZGF0YZAAAACAgICAgICAgP//AAD//wAA/v7+AAD/AAD///8AAP//AAD///8AAP8AAP7+/gAA/wAA////AAD//wAA////AAD/AAD+/v4AAP8AAP///wAA//8AAP///wAA/wAA/v7+AAD/AAD///8AAP//AAD///8AAP8AAP7+/gAA"></audio>

<script>
/*********** Estado y helpers seguros ***********/
const ST={ tRun:360, timer:null, startTs:null, laps:[], pauses:[], pauseActive:null };
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const getVal = id => (byId(id)||{}).value;
const getNum = id => { const s=getVal(id)||''; const n=parseFloat(s.replace(',','.').replace(/[^0-9.\-]/g,'')); return Number.isFinite(n)?n:NaN; };
const clamp = (v,a,b)=> Math.min(b, Math.max(a,v));
const fmt = t => { const m=Math.floor(t/60).toString().padStart(2,'0'), s=(t%60).toString().padStart(2,'0'); return m+':'+s; };
function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang=getVal('p_voz')||'es-CO'; u.rate=1.02; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function beep(){ const a=byId('beep'); if(a){ a.currentTime=0; a.play().catch(()=>{});} }

/*********** Tabla de minutos ***********/
function buildMinuteRows(){
  const tb=byId('tb_min'); tb.innerHTML='';
  const p1=getNum('post1_s')||0, p2=getNum('post2_s')||60;
  const rows=[[0,'Pre'],[1,'Min 1'],[2,'Min 2'],[3,'Min 3'],[4,'Min 4'],[5,'Min 5'],[6,'Min 6'],[6+p1/60,`Post #1 (${p1}s)`],[6+p2/60,`Post #2 (${p2}s)`]];
  rows.forEach(r=>{
    const tr=document.createElement('tr'); tr.dataset.t=r[0].toFixed(2);
    tr.innerHTML=`<td>${r[0].toFixed(2)}</td><td>${r[1]}</td>
      <td><input class="sp_in" data-t="${r[0]}" type="number" min="50" max="100"></td>
      <td><input class="fc_in" data-t="${r[0]}" type="number" min="20" max="240"></td>
      <td><input class="note_in" data-t="${r[0]}" placeholder=""></td>`;
    tb.appendChild(tr);
  });
}

/*********** Predicciones ***********/
function casas({edad,talla_cm,sexo}){ const male=(sexo==='M')?1:0; const pred=453.621+1.445*talla_cm-1.531*edad+48.559*male; const sd=46.8739; return {pred,lln:pred-1.645*sd,label:'Casas (Bogot√°)'}; }
function troosters({edad,talla_cm,peso_kg,sexo}){ const male=(sexo==='M')?1:0; const pred=218+5.14*talla_cm-5.32*edad-1.80*(peso_kg||0)+51.31*male; return {pred,lln:pred-1.645*56,label:'Troosters (1999)'}; }

/*********** Lectura de tabla ***********/
function readSeries(){
  const p1=getNum('post1_s')||0, p2=getNum('post2_s')||60;
  const times=[0,1,2,3,4,5,6,6+p1/60,6+p2/60];
  const rows=byId('tb_min').querySelectorAll('tr');
  const sp=[], fc=[], notes=[];
  rows.forEach((tr,i)=>{
    const spo2=parseFloat((tr.querySelector('.sp_in')||{}).value);
    const fcv =parseFloat((tr.querySelector('.fc_in')||{}).value);
    const note=(tr.querySelector('.note_in')||{}).value||'';
    sp.push({t:times[i], v:Number.isFinite(spo2)?spo2:NaN});
    fc.push({t:times[i], v:Number.isFinite(fcv)?fcv:NaN});
    notes.push({t:times[i], note});
  });
  return {sp,fc,times,notes};
}

/*********** C√°lculo ***********/
function compute(){
  const edad=getNum('p_edad'), sexo=getVal('p_sexo')||'F', talla=getNum('p_talla'), peso=getNum('p_peso');
  const pista=getNum('p_pista'), extra=getNum('extra_m')||0, eq=getVal('p_eq')||'casas';
  const model=(eq==='casas')?casas({edad,talla_cm:talla,sexo}):troosters({edad,talla_cm:talla,peso_kg:peso,sexo});
  const dist=(Number.isFinite(pista)? (ST.laps.length*2*pista + extra) : NaN);
  const {sp,fc,times,notes}=readSeries();
  const spVals=sp.map(o=>o.v).filter(Number.isFinite).map(v=>clamp(v,0,100));
  const nadir=spVals.length? Math.min.apply(null,spVals):NaN;
  const pre=sp[0]?.v, post1v=sp[7]?.v, delta=(Number.isFinite(pre)&&Number.isFinite(post1v))?(post1v-pre):NaN;
  let DDR=NaN; { const seg=sp.filter(p=>p.t>=0&&p.t<=6&&Number.isFinite(p.v)).map(p=>({t:p.t,y:100-clamp(p.v,0,100)})); if(seg.length>=2&&Number.isFinite(dist)&&dist>0){ let area=0; for(let i=0;i<seg.length-1;i++){ const a=seg[i],b=seg[i+1]; area+=(a.y+b.y)/2*(b.t-a.t);} DDR=area/dist; } }
  const DSP=(Number.isFinite(dist)&&Number.isFinite(nadir))? dist*nadir : NaN;
  const pct=(Number.isFinite(dist)&&Number.isFinite(model.pred)&&model.pred>0)? (100*dist/model.pred) : NaN;
  return {model,dist,pct,nadir,delta,DDR,DSP,series:{sp,fc,times,notes}};
}

/*********** Pintado ***********/
function drawChart(id,pts,yMin,yMax,label,color){
  const cv=byId(id); if(!cv) return;
  const dpr=window.devicePixelRatio||1, W=520,H=220,L=40,B=26,T=16,R=10;
  cv.width=W*dpr; cv.height=H*dpr; cv.style.width=W+'px'; cv.style.height=H+'px';
  const ctx=cv.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='rgba(0,0,0,.45)'; ctx.lineWidth=1; ctx.beginPath(); ctx.moveTo(L,T); ctx.lineTo(L,H-B); ctx.lineTo(W-R,H-B); ctx.stroke();
  ctx.fillStyle='#111'; ctx.font='12px system-ui';
  for(let i=0;i<=5;i++){ const y=H-B-(H-B-T)*(i/5); const v=(yMin+(yMax-yMin)*(i/5)).toFixed(0); ctx.strokeStyle='rgba(0,0,0,.06)'; ctx.beginPath(); ctx.moveTo(L,y); ctx.lineTo(W-R,y); ctx.stroke(); ctx.fillText(v,6,y+4); }
  if(!pts||!pts.length){ ctx.fillText(label,L,T-4); return; }
  const minX=Math.min.apply(null,pts.map(p=>p.x)), maxX=Math.max.apply(null,pts.map(p=>p.x));
  const X=x=> L + ((x-minX)/(maxX-minX||1))*(W-R-L);
  const Y=y=> H-B - ((y-yMin)/(yMax-yMin||1))*(H-B-T);
  ctx.strokeStyle=color||'#000'; ctx.lineWidth=2; ctx.beginPath();
  pts.forEach((p,i)=>{ const x=X(p.x), y=Y(p.y); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  ctx.fillStyle=color||'#000';
  pts.forEach(p=>{ const x=X(p.x), y=Y(p.y); ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill(); });
  ctx.fillStyle=color||'#000'; ctx.fillText(label, L, T-4);
}
function computeAnalysis(state){
  const {model,dist,pct,nadir,delta,DDR,DSP}=state;
  const msgs=[];
  if(Number.isFinite(model?.lln)&&Number.isFinite(dist)) msgs.push(dist<model.lln?'Distancia por debajo del LLN.':'Distancia dentro de lo esperado.');
  else if(Number.isFinite(pct)) msgs.push('Distancia ‚âà '+pct.toFixed(0)+'% del predicho.');
  if(Number.isFinite(nadir)) msgs.push('SpO‚ÇÇ nadir '+nadir.toFixed(1)+'%'+(nadir<88?' (hipoxemia).':''));
  if(Number.isFinite(delta)) msgs.push('ŒîSpO‚ÇÇ '+delta.toFixed(1)+'% '+(Math.abs(delta)>=4?'(‚â•4% relevante).':'(<4%).'));
  if(Number.isFinite(DDR)) msgs.push('DDR '+DDR.toFixed(3)+' %¬∑min/m.');
  if(Number.isFinite(DSP)) msgs.push('DSP '+DSP.toFixed(0)+' m¬∑%.');
  if(ST.pauses?.length){ const tot=ST.pauses.reduce((s,p)=>s+(p.dur||0),0); msgs.push('Pausas: '+ST.pauses.length+' ('+tot+' s).'); }
  const obs=(byId('obs')||{}).value||''; if(obs) msgs.push('Obs: '+obs);
  return msgs.join(' ');
}
function render(state){
  const {model,dist,pct,nadir,delta,DDR,DSP,series}=state;
  byId('k_m').textContent=Number.isFinite(dist)?dist.toFixed(1):'‚Äî';
  byId('k_pct').textContent=Number.isFinite(pct)?pct.toFixed(0)+' %':'‚Äî';
  byId('k_pred').textContent=Number.isFinite(model.pred)?model.pred.toFixed(1):'‚Äî';
  byId('k_lln').textContent=Number.isFinite(model.lln)?model.lln.toFixed(1):'‚Äî';
  byId('k_nadir').textContent=Number.isFinite(nadir)?nadir.toFixed(1):'‚Äî';
  byId('k_delta').textContent=Number.isFinite(delta)?delta.toFixed(1):'‚Äî';
  byId('k_ddr').textContent=Number.isFinite(DDR)?DDR.toFixed(3):'‚Äî';
  byId('k_dsp').textContent=Number.isFinite(DSP)?DSP.toFixed(0):'‚Äî';
  // sem√°foro
  ['k_nadir','k_delta'].forEach(id=>byId(id).classList.remove('warn','danger'));
  if(Number.isFinite(nadir)&&nadir<88) byId('k_nadir').classList.add('danger');
  if(Number.isFinite(delta)&&Math.abs(delta)>=4) byId('k_delta').classList.add('warn');
  const alerts=[]; if(Number.isFinite(model.lln)&&Number.isFinite(dist)&&dist<model.lln) alerts.push('Distancia < LLN');
  if(Number.isFinite(nadir)&&nadir<88) alerts.push('SpO‚ÇÇ nadir < 88%');
  if(Number.isFinite(delta)&&Math.abs(delta)>=4) alerts.push('ŒîSpO‚ÇÇ ‚â• 4 pp');
  byId('alertas').textContent=alerts.length?('‚ö†Ô∏é '+alerts.join(' ¬∑ ')):'';
  // curvas
  const ptsS=series.sp.filter(p=>Number.isFinite(p.v)).map(p=>({x:p.t,y:p.v}));
  const minS=ptsS.length?Math.min.apply(null,ptsS.map(p=>p.y)):88, yMinS=Math.max(70,Math.min(88,Math.floor(minS)-2));
  drawChart('cv_spo2',ptsS,yMinS,100,'SpO‚ÇÇ (%)','#007aff');
  const ptsH=series.fc.filter(p=>Number.isFinite(p.v)).map(p=>({x:p.t,y:p.v}));
  const minH=ptsH.length?Math.min.apply(null,ptsH.map(p=>p.y)):60, maxH=ptsH.length?Math.max.apply(null,ptsH.map(p=>p.y)):160;
  drawChart('cv_fc',ptsH,Math.max(40,minH-5),Math.min(220,maxH+10),'Frecuencia cardiaca (lpm)','#ff2d55');
  // recap
  const tb=byId('tb_min_recap'); tb.innerHTML='';
  for(let i=0;i<series.sp.length;i++){
    const lab=(i===0)?'Pre':(i<=6)?('Min '+i):(i===7)?'Post #1':'Post #2';
    const s=Number.isFinite(series.sp[i].v)?series.sp[i].v.toFixed(1):'‚Äî';
    const h=Number.isFinite(series.fc[i].v)?series.fc[i].v.toFixed(0):'‚Äî';
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${lab}</td><td>${s}</td><td>${h}</td><td>${series.notes[i]?.note||''}</td>`; tb.appendChild(tr);
  }
  byId('interpretacion').textContent = computeAnalysis(state);
}

/*********** Control prueba ***********/
const LIMITS={ edad:[10,100], talla:[120,220], pista:[5,60] };
function validateBasic(){ const issues=[]; const e=getNum('p_edad'), t=getNum('p_talla'), p=getNum('p_pista');
  if(!Number.isFinite(e)||e<LIMITS.edad[0]||e>LIMITS.edad[1]) issues.push('Edad v√°lida (10‚Äì100)');
  if(!Number.isFinite(t)||t<LIMITS.talla[0]||t>LIMITS.talla[1]) issues.push('Talla v√°lida (120‚Äì220 cm)');
  if(!Number.isFinite(p)||p<LIMITS.pista[0]||p>LIMITS.pista[1]) issues.push('Longitud entre conos (5‚Äì60 m)');
  if(issues.length){ alert('Antes de iniciar:\n‚Ä¢ '+issues.join('\n‚Ä¢ ')); return false } return true;
}
function highlightCurrentMinute(){ if(!ST.startTs) return; const elapsed=360-ST.tRun; const m=Math.max(0,Math.min(6,Math.floor(elapsed/60))); const key=m.toFixed(2);
  document.querySelectorAll('#tb_min tr').forEach(tr=>tr.classList.remove('row-current'));
  const row=document.querySelector(`#tb_min tr[data-t="${key}"]`); if(row) row.classList.add('row-current');
}
function clearRowHighlight(){ document.querySelectorAll('#tb_min tr').forEach(tr=>tr.classList.remove('row-current')); }

// ==== START TEST (reemplazar) ====
function startTest(){
  if(!validateBasic()) return;
  clearInterval(ST.timer);
  ST.tRun = 360;
  ST.startTs = Date.now();
  ST.laps = []; ST.pauses = []; ST.pauseActive = null;
  byId('laps_disp').textContent = '0';
  byId('reloj').textContent = fmt(ST.tRun);
  speak('Comience ahora. Camine lo m√°s que pueda durante seis minutos, sin correr.');

  // Frases estandarizadas (GPC/ATS)
  const PROMPTS = {
    300: 'Lo est√° haciendo bien. Le quedan cinco minutos.',
    240: 'Muy bien. Le quedan cuatro minutos.',
    180: 'Ha completado la mitad de la prueba. Mantenga el esfuerzo.',
    120: 'Muy bien. Solo le quedan dos minutos.',
     60: 'Excelente. Solo le queda un minuto.'
  };

  ST.timer = setInterval(()=>{
    ST.tRun--;
    byId('reloj').textContent = fmt(ST.tRun);
    highlightCurrentMinute();

    // Minutos 2,3,4,5 (restantes 4,3,2,1)
    if(PROMPTS[ST.tRun]){ beep(); speak(PROMPTS[ST.tRun]); }

    // Aviso a 30 segundos
    if(ST.tRun === 30){ beep(); speak('Faltan treinta segundos. Iniciar√© una cuenta regresiva.'); }

    // Cuenta regresiva 10‚Äì1
    if(ST.tRun === 10){ beep(); speak('Diez'); }
    if([9,8,7,6,5,4,3,2,1].includes(ST.tRun)){ beep(); speak(String(ST.tRun)); }

    if(ST.tRun <= 0){
      endTest();
    }
  }, 1000);
}
function endTest(){ clearInterval(ST.timer); clearRowHighlight(); render(compute()); speak('Fin: det√©ngase donde se encuentre.'); }
function addLap(){
  const now = Date.now();
  if (now - (ST._lapGuard||0) < 250) return; // anti-doble-disparo 250 ms
  ST._lapGuard = now;

  if (!ST.startTs) ST.startTs = Date.now();
  ST.laps.push({ t: Math.floor((Date.now() - ST.startTs) / 1000) });
  byId('laps_disp').textContent = String(ST.laps.length);
  render(compute());
  beep();
}
function undoLap(){ if(!ST.laps.length) return; ST.laps.pop(); byId('laps_disp').textContent=String(ST.laps.length); render(compute()); }
function markMinute(){ beep(); }
function startPause(){ if(ST.pauseActive) return; ST.pauseActive={start:Math.floor((Date.now()-ST.startTs)/1000),cause:getVal('pause_cause')||'otra'};
  document.querySelector('[data-cmd="pstart"]').disabled=true; document.querySelector('[data-cmd="pend"]').disabled=false; speak('Pausa registrada. Reanude cuando est√© listo.'); }
function endPause(){ if(!ST.pauseActive) return; const end=Math.floor((Date.now()-ST.startTs)/1000), dur=Math.max(0,end-ST.pauseActive.start);
  ST.pauses.push({start:ST.pauseActive.start,end,dur,cause:ST.pauseActive.cause}); ST.pauseActive=null;
  document.querySelector('[data-cmd="pstart"]').disabled=false; document.querySelector('[data-cmd="pend"]').disabled=true;
  const tb=byId('tb_pausas'); tb.innerHTML=''; ST.pauses.forEach((p,i)=>{ const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${p.start}</td><td>${p.end}</td><td>${p.dur}</td><td>${p.cause}</td>`; tb.appendChild(tr); });
}

/*********** Delegaci√≥n/Listeners (sin usar global event) ***********/
function on(container, event, selector, handler){
  container.addEventListener(event, (e)=>{ const el=e.target.closest(selector); if(el&&container.contains(el)) handler(e,el); });
}

let LOGO_DATA=null;
window.addEventListener('DOMContentLoaded', ()=>{
  buildMinuteRows(); render(compute());

  // Entradas de datos (sin usar 'event' global)
  on(byId('sec-datos'),'input','input,select',(e)=>{
    const id=(e.target||{}).id||''; if(id==='post1_s'||id==='post2_s') buildMinuteRows();
    render(compute());
  });
  on(byId('sec-ejec'),'input','#tb_min input',()=>{ render(compute()); });
  on(byId('sec-ejec'),'input','#extra_m',()=>{ render(compute()); });

  // Botones
  on(document,'click','[data-cmd]',(e,btn)=>{
    const cmd=btn.getAttribute('data-cmd');
    if(cmd==='instr') speak('Realizaremos la caminata de seis minutos. Camine la mayor distancia posible sin correr. Ida y vuelta entre los conos; gire por detr√°s. Puede disminuir el paso o detenerse; reanude pronto. Avisar√© cada minuto y har√© cuenta regresiva los √∫ltimos diez segundos.');
    if(cmd==='start') startTest();
    if(cmd==='mark')  markMinute();
    if(cmd==='end')   endTest();
    if(cmd==='lap')   addLap();
    if(cmd==='undo')  undoLap();
    if(cmd==='pstart')startPause();
    if(cmd==='pend')  endPause();
  });

  // PDF + logo (dentro del √öNICO DOMContentLoaded)
const btnPDF = byId('btn_pdf');
if (btnPDF) btnPDF.addEventListener('click', generatePDF);

const logo = byId('logo_file');
if (logo) logo.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ()=> window.LOGO_DATA = r.result;
  r.readAsDataURL(f);
});

});

function generatePDF() {
  // Asegura KPIs/curvas actualizados en pantalla
  const state = compute();
  render(state);

  // Snapshots de los canvas (colores ya aplicados)
  const cvSp = document.getElementById('cv_spo2');
  const cvHr = document.getElementById('cv_fc');
  const imgSp = (cvSp && cvSp.toDataURL) ? cvSp.toDataURL('image/png') : '';
  const imgHr = (cvHr && cvHr.toDataURL) ? cvHr.toDataURL('image/png') : '';

  // Datos y an√°lisis
  const now    = new Date().toLocaleString('es-CO');
  const nombre = getVal('p_nombre') || '‚Äî';
  const pid    = getVal('p_id')     || '‚Äî';
  const edad   = getNum('p_edad');
  const sexo   = getVal('p_sexo') || 'F';
  const talla  = getNum('p_talla');
  const peso   = getNum('p_peso');
  const pista  = getNum('p_pista');
  const analisis = computeAnalysis(state);

  // Datos de cl√≠nica (nuevos)
  const clinicName = getVal('clinic_name') || 'Unidad de Neumolog√≠a';
  const clinicAddr = getVal('clinic_addr') || '';
  const clinicTel  = getVal('clinic_tel')  || '';

  // Ventana de impresi√≥n (estilo minimalista)
  const W = window.open('', 'print', 'width=900,height=700');
  W.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>6MWT ‚Äî Informe</title>
  <style>
    @page{size:Letter;margin:22mm 16mm}
    body{font:14px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;color:#000;background:#fff}
    h1{margin:0;font:800 22px/1.2 system-ui}
    h2{margin:0;font:700 16px/1.2 system-ui}
    h3{margin:0;font:600 14px/1.2 system-ui}
    .mut{color:#333}
    .hdr{display:grid;grid-template-columns:1fr 1fr;gap:8px;align-items:end;margin:0 0 10mm}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .k{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:8px 0}
    .box{border:1px solid #dcdcdc;border-radius:10px;padding:8px}
    .ttl{color:#555;font-size:12px;margin:0 0 2px}
    .v{font:700 18px/1 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    img.chart{width:100%;height:auto;border:1px solid #e5e5e5;border-radius:8px}
    table{border-collapse:collapse;width:100%;font-size:12px}
    th,td{border-bottom:1px solid #e8e8e8;padding:6px;text-align:left}
    .accent{color:#007aff}.accent2{color:#ff2d55}
    .footer{margin-top:12mm;font:600 12px/1 system-ui;text-align:right}
  </style></head><body>`);

  // Encabezado enfrentado: cl√≠nica (izquierda) vs t√≠tulo (derecha)
  W.document.write(`
  <div class="hdr">
    <div style="text-align:left">
      <div style="font:800 22px/1.2 -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial">
        ${clinicName}
      </div>
      <div class="mut" style="font:600 13px/1.2 system-ui">${clinicAddr}</div>
      <div class="mut" style="font:600 13px/1.2 system-ui">${clinicTel}</div>
    </div>
    <div style="text-align:right">
      <h1>Unidad de Neumolog√≠a</h1>
      <h2>Pruebas de funci√≥n Pulmonar</h2>
      <h3>Dr Eduardo Reyes S. ‚Äî Internista Neum√≥logo</h3>
    </div>
  </div>
`)

  // Datos de paciente
  W.document.write(`
    <div class="grid">
      <div class="box"><b>Paciente:</b> ${nombre}<br><b>ID:</b> ${pid}
        <br><b>Sexo:</b> ${sexo==='M'?'Masculino':'Femenino'} ‚Ä¢ <b>Edad:</b> ${Number.isFinite(edad)?edad:'‚Äî'} a√±os
      </div>
      <div class="box"><b>Talla:</b> ${Number.isFinite(talla)?talla.toFixed(1):'‚Äî'} cm ‚Ä¢ <b>Peso:</b> ${Number.isFinite(peso)?peso.toFixed(1):'‚Äî'} kg
        <br><b>Pista:</b> ${Number.isFinite(pista)?pista.toFixed(1):'‚Äî'} m
      </div>
    </div>
  `);

  // Ecuaci√≥n usada (Casas/Troosters)
  const eqVal   = getVal('p_eq') || 'casas';
  const eqLabel = state.model?.label || (eqVal==='casas' ? 'Casas (Bogot√°)' : 'Troosters (1999)');
  const eqText  = (eqVal==='casas')
    ? 'Pred (m) = 453.621 + 1.445¬∑talla_cm ‚àí 1.531¬∑edad + 48.559¬∑sexo(1=M,0=F). DE = 46.8739; LLN = Pred ‚àí 1.645¬∑DE.'
    : 'Pred (m) = 218 + 5.14¬∑talla_cm ‚àí 5.32¬∑edad ‚àí 1.80¬∑peso_kg + 51.31¬∑sexo(1=M,0=F). DE ‚âà 56; LLN = Pred ‚àí 1.645¬∑DE.';
  W.document.write(`
    <div class="box" style="margin:8px 0">
      <b>Ecuaci√≥n de referencia:</b> ${eqLabel}<br>
      <span class="mut">${eqText}</span>
    </div>
  `);

  // KPIs
  W.document.write(`
    <div class="k">
      <div class="box"><div class="ttl">Distancia (m)</div><div class="v">${Number.isFinite(state.dist)?state.dist.toFixed(1):'‚Äî'}</div></div>
      <div class="box"><div class="ttl">% del predicho</div><div class="v">${Number.isFinite(state.pct)?state.pct.toFixed(0)+' %':'‚Äî'}</div></div>
      <div class="box"><div class="ttl">Predicho / LLN (m)</div><div class="v">${Number.isFinite(state.model?.pred)?state.model.pred.toFixed(0):'‚Äî'} / ${Number.isFinite(state.model?.lln)?state.model.lln.toFixed(0):'‚Äî'}</div></div>
      <div class="box"><div class="ttl">Velocidad (m/s)</div><div class="v">${Number.isFinite(state.dist)?(state.dist/360).toFixed(2):'‚Äî'}</div></div>
    </div>
    <div class="k">
      <div class="box"><div class="ttl">SpO‚ÇÇ nadir (%)</div><div class="v accent">${Number.isFinite(state.nadir)?state.nadir.toFixed(1):'‚Äî'}</div></div>
      <div class="box"><div class="ttl">ŒîSpO‚ÇÇ (%)</div><div class="v">${Number.isFinite(state.delta)?state.delta.toFixed(1):'‚Äî'}</div></div>
      <div class="box"><div class="ttl">DDR (%¬∑min/m)</div><div class="v">${Number.isFinite(state.DDR)?state.DDR.toFixed(3):'‚Äî'}</div></div>
      <div class="box"><div class="ttl">DSP (m¬∑%)</div><div class="v">${Number.isFinite(state.DSP)?state.DSP.toFixed(0):'‚Äî'}</div></div>
    </div>
  `);

  // Curvas (im√°genes)
  W.document.write(`
    <div class="grid" style="margin:8px 0">
      <div><div class="mut">Curva <span class="accent">SpO‚ÇÇ</span> vs tiempo</div><img id="img_sp" class="chart" alt="SpO‚ÇÇ"></div>
      <div><div class="mut">Curva <span class="accent2">FC</span> vs tiempo</div><img id="img_hr" class="chart" alt="FC"></div>
    </div>
  `);

  // Serie por minuto
  const sp = state.series?.sp || [], fc = state.series?.fc || [], notes = state.series?.notes || [];
  let rows = '';
  for(let i=0;i<sp.length;i++){
    const lab=(i===0)?'Pre':(i<=6)?('Min '+i):(i===7)?'Post #1':'Post #2';
    const s=Number.isFinite(sp[i].v)?sp[i].v.toFixed(1):'‚Äî';
    const h=Number.isFinite(fc[i].v)?fc[i].v.toFixed(0):'‚Äî';
    rows += `<tr><td>${lab}</td><td>${s}</td><td>${h}</td><td>${notes[i]?.note||''}</td></tr>`;
  }
  W.document.write(`
    <div class="mut" style="margin:6px 0"><b>Serie por minuto</b></div>
    <table><thead><tr><th>Tiempo</th><th>SpO‚ÇÇ (%)</th><th>FC (lpm)</th><th>Obs</th></tr></thead><tbody>${rows}</tbody></table>
    <div class="mut" style="margin-top:8px"><b>An√°lisis e interpretaci√≥n</b><br>${analisis}</div>
    <div class="footer">Realizado por Yuly K Medrano Le√≥n ‚Äî Fisioterapeuta</div>
  `);

  W.document.write('</body></html>');
  W.document.close();

  // Espera a que las im√°genes se carguen antes de imprimir
  const spEl = W.document.getElementById('img_sp');
  const hrEl = W.document.getElementById('img_hr');
  let pending = 2;
  function done(){ if(--pending<=0){ setTimeout(()=>{ W.focus(); W.print(); }, 120); } }
  spEl.onload = done; spEl.onerror = done; spEl.src = imgSp || '';
  hrEl.onload = done; hrEl.onerror = done; hrEl.src = imgHr || '';
}



/*********** Construcci√≥n inicial y delegaci√≥n ***********/
function on(container, event, selector, handler){
  container.addEventListener(event, (e)=>{ const el=e.target.closest(selector); if(el&&container.contains(el)) handler(e,el); });
}
function highlightCurrentMinute(){ if(!ST.startTs) return; const elapsed=360-ST.tRun; const m=Math.max(0,Math.min(6,Math.floor(elapsed/60))); const key=m.toFixed(2);
  document.querySelectorAll('#tb_min tr').forEach(tr=>tr.classList.remove('row-current')); const row=document.querySelector(`#tb_min tr[data-t="${key}"]`); if(row) row.classList.add('row-current'); }
function clearRowHighlight(){ document.querySelectorAll('#tb_min tr').forEach(tr=>tr.classList.remove('row-current')); }

window.addEventListener('DOMContentLoaded', ()=>{
  buildMinuteRows(); render(compute());

  on(byId('sec-datos'),'input','input,select',(e)=>{
    const id=(e.target||{}).id||''; if(id==='post1_s'||id==='post2_s') buildMinuteRows(); render(compute());
  });
  on(byId('sec-ejec'),'input','#tb_min input',()=> render(compute()));
  on(byId('sec-ejec'),'input','#extra_m',()=> render(compute()));

  on(document,'click','[data-cmd]',(e,btn)=>{
    const cmd=btn.getAttribute('data-cmd');
    if(cmd==='instr') speak('Realizaremos la caminata de seis minutos. Camine la mayor distancia posible sin correr. De ida y vuelta entre los conos; gire por detr√°s. Puede disminuir el paso o detenerse; reanude pronto. Avisar√© cada minuto y har√© cuenta regresiva los √∫ltimos diez segundos.');
    if(cmd==='start') startTest();
    if(cmd==='mark')  markMinute();
    if(cmd==='end')   endTest();
    if(cmd==='lap')   addLap();
    if(cmd==='undo')  undoLap();
    if(cmd==='pstart')startPause();
    if(cmd==='pend')  endPause();
  });

  byId('btn_pdf').addEventListener('click', generatePDF);
  byId('logo_file')?.addEventListener('change',(e)=>{
    const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=> window.LOGO_DATA=r.result; r.readAsDataURL(f);
  });
});
</script>
</body>
</html>
